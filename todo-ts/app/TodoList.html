<div class="col-pp-100 col-pl-50 col-tl-33">
<ul class="ui right floated horizontal list">
  <li class="item" title="sort">
    <a disabled="{{ loading || 2 > size }}" on:click="toggleDesc(store)">
      <i class="{{ desc ? 'icon desc-yes' : 'icon desc-no' }}"></i>
    </a>
  </li>
  <li class="item" title="refresh">
    <a title="refresh" disabled="{{ loading || 0 === size }}" on:click="fetchUpdate(store)">
      <i class="icon cw"></i>
    </a>
  </li>
  <li class="item">  
    <a disabled="{{ loading || 0 === page }}" on:click="goto(0, store)">
      <i class="icon angle-double-left"></i>
    </a>
  </li>
  <li class="item">
    <a disabled="{{ loading }}" on:click="prevOrLoad(store)">
      <i class="icon angle-left"></i>
    </a>
  </li>
  <li class="item">
    <a disabled="{{ loading || 0 === size }}" on:click="nextOrLoad(store)">
      <i class="icon angle-right"></i>
    </a>
  </li>
  <li class="item">
    <a disabled="{{ loading || page_count === page }}" on:click="goto(page_count, store)">
      <i class="icon angle-double-right"></i>
    </a>
  </li>
  <li ref:plus class="item" title="add">
    <a><i class="icon plus"></i></a>
  </li>
  <li ref:filter class="item" title="filter">
    <a><i class="icon filter"></i></a>
  </li>
</ul>
<ul class="ui horizontal list">
  <li class="item">
    <sup>{{ page_info }}</sup>
  </li>
</ul>
<div class="{{ !errmsg ? 'hide' : 'ui msg error' }}">
  <i class="icon close" on:click="set({ errmsg: '' })"></i>
  {{ errmsg }}
</div>
<ul class="ui small divided selection list">
  {{#each items as item}}
  <TodoItem item="{{ item }}" />
  {{/each}}
</ul>
</div>
<script>
import { defp } from 'coreds/lib/util'
import * as rpc from 'coreds/lib/rpc/'
import { Store } from 'coreds/lib/store/'
import { wrapPojo, mergePojo } from './util'

import TodoItem from './TodoItem.html'

const PAGE_SIZE = 5,
    MULTIPLIER = 3

function fetch(req) {
    return rpc.post('/todo/user/Todo/list', JSON.stringify(req))
}

export default {
    components: {
        TodoItem
    },
    data() {
        let store = new Store(null, wrapPojo, mergePojo, PAGE_SIZE, MULTIPLIER),
            items = defp(store, 'items', [])
        for (var i = 0; i < PAGE_SIZE; i++) items.push({ c$: null })
        return {
            errmsg: '',
            loading: false,
            desc: true,
            size: 0,
            page: 0,
            page_count: 0,
            store,
            items
        }
    },
    oncreate() {
        let state = this.get(),
            opts = state['opts'],
            store = state['store']
        store.vm = this
        defp(this, 'm', {
            fetch$$S: store.cbFetchSuccess.bind(store),
            fetch$$F: store.cbFetchFailed.bind(store),
            fetch: opts && opts.fetch ? opts.fetch.bind(this) : fetch,
            store
        })
        store.fetchNewer()
    },
    computed: {
        page_info(page, size, desc, store) {
            let items = store.items
            if (!items[0].c$) return ''

            let page_items = store.page_items(),
                len = page_items.length,
                i = 0
            for (; i < len; i++) items[i].c$.update(page_items[i].orig)
            for (len = items.length; i < len; i++) items[i].c$.update(null)

            return store.page_info() 
        }
    },
    methods: {
        goto(page, store) { store.goto(page) },
        toggleDesc(store) { store.toggleDesc() },
        fetchUpdate(store) { store.fetchUpdate() },
        prevOrLoad(store) { store.prevOrLoad() },
        nextOrLoad(store) { store.nextOrLoad() },
        fetch(req) {
            let m = this.m
            return m.fetch(req).then(m.fetch$$S).then(undefined, m.fetch$$F)
        }
    }
}
</script>